name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      browser:
        description: 'Select Browser'
        required: true
        default: 'all'
        type: choice
        options: [all, chromium, firefox, webkit]
      parallel:
        description: 'Parallel execution'
        required: true
        default: 'true'
        type: choice
        options: ['true', 'false']
      workers:
        description: 'Workers count'
        required: true
        default: '3'
        type: string

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: |
          # 1. Parse the multi-line secret 'DEMOQA' into individual variables
          echo "Processing multi-line secret..."
          echo "${{ secrets.DEMOQA }}" | while read -r line; do
            if [[ ! -z "$line" && "$line" == *"="* ]]; then
              # Remove spaces and quotes (single and double)
              clean_line=$(echo "$line" | tr -d '[:space:]' | tr -d "'" | tr -d '"')
              echo "$clean_line" >> $GITHUB_ENV
            fi
          done

          # 2. Debugging: Verify variables are loaded (values will be masked as ***)
          echo "Verifying environment variables..."
          echo "BASE_URL is set: ${BASE_URL:+yes}"
          echo "APP_USERNAME is set: ${APP_USERNAME:+yes}"
          echo "APP_PASSWORD is set: ${APP_PASSWORD:+yes}"

          # 3. Handle browser selection
          BROWSER_FLAG=""
          if [ "${{ github.event.inputs.browser || 'all' }}" != "all" ]; then
            BROWSER_FLAG="--project=${{ github.event.inputs.browser }}"
          fi

          # 4. Handle parallelism
          PARALLEL_FLAG="--fully-parallel"
          if [ "${{ github.event.inputs.parallel }}" == "false" ]; then
            PARALLEL_FLAG="--no-fully-parallel"
          fi

          # 5. Execute Command
          npx playwright test $BROWSER_FLAG $PARALLEL_FLAG --workers=${{ github.event.inputs.workers || 3 }}
        env:
          CI: true

      - name: Upload Shareable Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-single-file
          path: testAssets/artifacts/allure-report/index.html
          retention-days: 30